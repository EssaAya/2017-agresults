# Data Summaries

This section provides visual summaries for a sample of variables. All estimates below are for surveyed households (after imputing missing/invalid locations). Complete results are available in **STATA format** on [Huddle](https://abtassociates.huddle.com/workspace/734056/files/#/folder/1170295/list).

<u>Note</u>: the *violin* (pirate) plots below show **median** line in **red**, **mean** line in **green**, and the **blue** region is the inferred **95% confidence interval** of the mean.


```{r extract, eval=FALSE}

# Limit to whatever locations are in `pts`
nga.pts$ISO3 <- "NGA"
ken.pts$ISO3 <- "KEN"
uga.pts$ISO3 <- "UGA"

pts <- rbind(
  nga.pts[, c("hhid", "ISO3", "adm0_name", "adm1_name", "adm2_name")], 
  ken.pts[, c("hhid", "ISO3", "adm0_name", "adm1_name", "adm2_name")])

pts.lbl <- c("household id", "ISO3 country code",
  "GADM admin level-0", "GADM admin level-1", "GADM admin level-2")

bio.lbl <- c(
  "Annual Mean Temperature",
  "Mean Diurnal Range (Mean of monthly (max temp - min temp))",
  "Isothermality (BIO2/BIO7) (* 100)",
  "Temperature Seasonality (standard deviation *100)",
  "Max Temperature of Warmest Month",
  "Min Temperature of Coldest Month",
  "Temperature Annual Range (BIO5-BIO6)",
  "Mean Temperature of Wettest Quarter",
  "Mean Temperature of Driest Quarter",
  "Mean Temperature of Warmest Quarter",
  "Mean Temperature of Coldest Quarter",
  "Annual Precipitation",
  "Precipitation of Wettest Month",
  "Precipitation of Driest Month",
  "Precipitation Seasonality (Coefficient of Variation)",
  "Precipitation of Wettest Quarter",
  "Precipitation of Driest Quarter",
  "Precipitation of Warmest Quarter",
  "Precipitation of Coldest Quarter")

#####################################################################################
# Travel Times
#####################################################################################
pts.tt <- extract(tt, pts)
pts.tt <- data.table(cbind(pts@data, pts.tt))
rm(tt)

# Export to STATA (1 file per country)
pts.tt.lbl <- c(pts.lbl, c(
  "travel time to 20K market (hrs)",
  "travel time to 50K market (hrs)",
  "travel time to 100K market (hrs)",
  "travel time to 250K market (hrs)",
  "travel time to 500K market (hrs)"))

for(i in c("NGA", "KEN")) write.dta(
  setattr(pts.tt[ISO3==i], "var.labels", pts.tt.lbl),
  paste0("./out/2017-agresults-", i, "_traveltime.dta"), 
  convert.factors="string", version=12L)

#####################################################################################
# AfSIS/SoilGrids
#####################################################################################
# Use REST API at https://rest.soilgrids.org/
# Note that `rjson` is required (`jsonlite` won't do)
library(rjson)
library(sp)
# Test 2 points, could also add aluminum concentration `ALUM3S`
r <- REST.SoilGrids(c("ORCDRC","TAXNWRB"))
# => lots of random errors to return just 100 point batches
tmp <- over(r, pts[1:2,])

# Query SoilGrids API in batches of 100 points (73 batches)
# anything bigger seems to error out. Batch #11 errors individually.
tmp <- lapply(seq(1, nrow(pts), 100)[21:30], 
  function(x) {
    df <- over(r, pts[x:min((x+99), nrow(pts)),])
    df <- df[, c(3:9, 128, 145:146)]
    return(df)
  })

###############################################
# SoilGrids API is a little slow for over 7,000 points, can we extract from disk
# instead, and then post-process NA and invalid values?
tmp <- lapply(1:nrow(afsis), function(x) {
  r <- raster(afsis[x, raster])
  res <- extract(r, pts)
  cat("done", x, "\n")
  return(res)
})
  
pts.soil <- data.table(do.call(cbind, tmp))
setnames(pts.soil, tolower(afsis$varCode))
pts.soil <- data.table(cbind(pts@data, pts.soil))

# Post-process
summary(pts.soil)
# => looks OK
# What's the codification for `taxnwrb_250m_ll`
# This is available in rgdal::GDALinfo(afsis[, last(raster)])
# Use column MINIMUM as integer
afsis.lbl <- fread("ftp://ftp.soilgrids.org/legends/TAXNWRB.txt")
setkey(afsis.lbl, MINIMUM)
setkey(pts.soil, taxnwrb_250m_ll)
pts.soil[afsis.lbl, taxnwrb_250m_class := i.NAME]
pts.soil[, .N, by=taxnwrb_250m_class]
#            taxnwrb_250m_class    N
#  1:                        NA    2
#  2:           Haplic Acrisols 3217
#  3:            Vetic Acrisols    4
#  4:         Aluandic Andosols  185
#  5:        Ferralic Arenosols   44
#  6:       Hypoluvic Arenosols    3
#  7:        Ferralic Cambisols   74
#  8:          Haplic Cambisols  184
#  9:  Haplic Cambisols (Humic)    1
# 10:         Haplic Ferralsols  453
# 11:         Umbric Ferralsols    6
# 12:           Mollic Gleysols    1
# 13:          Haplic Leptosols    1
# 14:          Lithic Leptosols    4
# 15:         Rendzic Leptosols    3
# 16:           Haplic Lixisols 1189
# 17:           Haplic Luvisols  804
# 18: Haplic Luvisols (Chromic)   19
# 19:           Vertic Luvisols    6
# 20:  Haplic Nitisols (Rhodic)  893
# 21:          Haplic Phaeozems    1
# 22:           Luvic Phaeozems   43
# 23:             Aric Regosols    6
# 24:          Calcic Vertisols   17
# 25:          Haplic Vertisols  139
# 26: Haplic Vertisols (Eutric)    1

# Which 2 points are NA?
pts.soil[is.na(taxnwrb_250m_class), hhid]
# [1] 110418 110421 (Nigeria)
tmap_mode("view")
tm_shape(pts[pts$hhid %in% c(10418, 110421),]) + tm_dots()
# => TODO they are in a water body, we should move them


# Export to STATA (1 file per country)
pts.soil.lbl <- c(pts.lbl, afsis[, varLabel], "soil class based on the WRB (label)")

for(i in c("NGA", "KEN")) write.dta(
  setattr(pts.soil[ISO3==i], "var.labels", pts.soil.lbl),
  paste0("./out/2017-agresults-", i, "_soil.dta"), 
  convert.factors="string", version=12L)

#####################################################################################
# WorldClim Biovars
#####################################################################################
# Download tile and extract single point data, tiles are cached locally
# For Nigeria we need tiles #26 "bio1_26"
# For Kenya we need tiles #27 and #37 "bio1_27"
# Each of the 19 bioclim variables is available in a .bil raster
vars <- paste0("bio", 1:19)

# Nigeria (#26)
nga.wc <- lapply(vars, function(x) {
  r <- raster(paste0("~/Projects/hc-data/WorldClim_0.5/", x, "_26.bil"))
  tmp <- extract(r, pts[pts$ISO3=="NGA",])
  tmp <- data.table(tmp)
  setnames(tmp, x)
  return(tmp)
})

# Combine all vars
nga.wc <- do.call(cbind, nga.wc)
nga.wc <- cbind(pts@data[pts$adm0_name=="Nigeria",], nga.wc)

# Kenya (#27, #37)
ken.wc <- lapply(vars, function(x) {
  r27 <- raster(paste0("~/Projects/hc-data/WorldClim_0.5/", x, "_27.bil"))
  r37 <- raster(paste0("~/Projects/hc-data/WorldClim_0.5/", x, "_37.bil"))
  tmp27 <- extract(r27, pts[pts$ISO3=="KEN",])
  tmp37 <- extract(r37, pts[pts$ISO3=="KEN",])
  tmp <- data.table(rowMeans(cbind(tmp27, tmp37), na.rm=T))
  setnames(tmp, x)
  return(tmp)
})

# Combine all vars
ken.wc <- do.call(cbind, ken.wc)
ken.wc <- cbind(pts@data[pts$ISO3=="KEN",], ken.wc)

# TODO Uganda

# Combine all countries
pts.wc <- rbind(nga.wc, ken.wc)
rm(ken.wc, nga.wc, uga.wc)


#####################################################################################
# Add SRTM Altitude and Slope
pts.srtm <- lapply(c("NGA", "KEN"), function(x) {
  r <- getData("alt", country=x, mask=F, path="~/Projects/hc-data/SRTM")
  tmp1 <- extract(r, pts[pts$ISO3==x,])
  slope <- terrain(r, opt=c("slope"), unit="degrees")
  tmp2 <- extract(slope, pts[pts$ISO3==x,])
  tmp <- data.table(cbind(tmp1, tmp2))
  setnames(tmp, c("alt", "slope"))
  return(tmp)
  })

pts.srtm <- rbindlist(pts.srtm)
pts.wc <- data.table(cbind(pts.wc, pts.srtm))
rm(pts.srtm)

# Export WorldClim and SRTM to STATA (1 file per country)
pts.wc.lbl <- c(pts.lbl, bio.lbl,
  "altitude (meter)", "slope (degree)")

for(i in c("NGA", "KEN")) write.dta(
  setattr(pts.wc[ISO3==i], "var.labels", pts.wc.lbl),
  paste0("./out/2017-agresults-", i, "_biovars.dta"), 
  convert.factors="string", version=12L)


#####################################################################################
# FEWSNET
#####################################################################################
# We need to iterate through all FEWS grids catalogued in `fews`, noting that missing 
# and invalid values will need extra correction. In general all r[r<0] should be NA, 
# aside from `ndvi_anom` et `et_anom` but that step takes time, maybe best to
# post-process (stretch, scale and nil) these values.
# We've also checked that FEWS layer projections are as expected.




# Export FEWS results to STATA (1 file per country)
pts.fews.lbl <- c(pts.lbl, 
  "altitude (meter)", "slope (degree)")

for(i in c("NGA", "KEN")) write.dta(
  setattr(pts.fews[ISO3==i], "var.labels", pts.fews.lbl),
  paste0("./out/2017-agresults-", i, "_fews.dta"), 
  convert.factors="string", version=12L)

```

```{r pts-save, eval=FALSE}

rm(i, x, dir, url, tmp, log, pet, tmp1, tmp2, r, slope, m, vars)
save.image("./tmp/2017-agresults.RData")

```


## Bioclimatic Indicators

Distribution of 2 long-term bioclimatic indicators at AgResults' household locations in Nigeria and Kenya.

```{r res-wc, fig.cap="Distribution of Long-Term Precipitation and Temperature Seasonality at Household Locations across States/Regions (1970-2000, percent std. dev.) Source: WorldClim."}

par(mfrow=c(1,2))
for (i in c("NGA", "KEN")) {
pplot(bio4~adm1_name, data=pts.wc[ISO3==i], 
  ylab="Temperature Seasonality (100*std. dev.)", xlab=NA)
pplot(bio15~adm1_name, data=pts.wc[ISO3==i], 
  ylab="Precipitation Seasonality (coeff of var.)", xlab=NA)
}

```

Distribution of last dekade's rainfall and NDVI at household locations.

```{r res-fews, eval=F, fig.cap="Distribution of Precipitation and NDVI at Household Locations across States/Regions (last dekade) Source: FEWSNET."}

par(mfrow=c(1,2))
for (i in c("NGA", "KEN")) {
pplot(chirps~adm1_name, data=pts.fews[ISO3==i], 
  ylab="Precipitation (CHIRPS)", xlab=NA)
pplot(ndvi~adm1_name, data=pts.fews[ISO3==i], 
  ylab="NDVI (smoothed, MODISC6)", xlab=NA)
}

```

## Soil Characteristics

```{r res-afsis, fig.cap="Distribution of Soil Organic Carbon at Household Locations across States/Regions (1970-2000, percent std. dev.) Source: SoilGrids 250m."}

par(mfrow=c(1,2))
for (i in c("NGA", "KEN")) {
pplot(orcdrc_m_sl1_250m_ll~adm1_name, data=pts.soil[ISO3==i], 
  ylab="Soil Organic Carbon (0 cm, permilles)", xlab=NA)
pplot(orcdrc_m_sl4_250m_ll~adm1_name, data=pts.soil[ISO3==i], 
  ylab="Soil Organic Carbon (30 cm, permilles)", xlab=NA)
}

```

## Drought

## Market Access

```{r res-tt, fig.cap="Distribution of Travel Times to Market at Household Locations across States/Regions (hrs). Source: IFPRI/HarvestChoice."}

par(mfrow=c(1,2))
for (i in c("NGA", "KEN")) {
pplot(tt10_20k~adm1_name, data=pts.tt[ISO3==i], 
  ylab="Travel Time to 20K Market (hrs)", xlab=NA)
pplot(tt10_100k~adm1_name, data=pts.tt[ISO3==i], 
  ylab="Travel Time to 100K Market (hrs)", xlab=NA)
}

```

