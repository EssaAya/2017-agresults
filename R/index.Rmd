---
title: "Geospatial Characteristics of Households"
author: "[BACOU, Melanie](http://github.com/mbacou) for [AgResults](http://agresults.org/) (Abt Associates)"
date: "Last updated on `r Sys.Date()`. DO NOT USE OR CITE"
description: "Biophysical, socio-economic, and market information derived from high-resolution remote sensing and modeled time series."
site: bookdown::bookdown_site
knit: bookdown::render_book
output:
  bookdown::gitbook:
    url: "https://mbacou.github.io/2017-agresults/"
    github-repo: "mbacou/2017-agresults"
df_print: paged
always_allow_html: yes
bibliography: biblio.bib
cover-image: fig/cover.jpg
csl: apa.csl
link-citations: yes
nocite: |
---

```{r setup, include=F}

library(raster)
library(data.table)
library(tables)
library(tmap)
library(viridis)
library(knitr)

load("../tmp/2017-abt.RData")

# Output options
opts_chunk$set(comment=NA, warning=F, message=F, echo=F, base.url="../docs",
  dev="svg", fig.path="fig/", fig.width=7, fig.height=3.8, dpi=300, cache=T, 
  dev.args=list(
    png=list(family="Roboto Condensed", pointsize=9), 
    svg=list(family="Roboto Condensed")))
table_options(htmloptions(justification="c", head=F, pad=T))

```


```{r nga, eval=FALSE}

load("./tmp/2017-abt.RData")

#####################################################################################
# Nigeria Locations
#####################################################################################
# Load NGA coords
nga.hh <- fread("./data/GIS Coordinates for Mel.csv")
setnames(nga.hh, c("hhid", "calc_state", "calc_lga", "calc_village", "Y", "X"))

# Impute missing with LGA centroid
nga.l2 <- shapefile("~/Google Drive/2016-BMGF-Segmentation/NGA/maps/admin/g2015_2014_2_NGA.shp")

# Reproject
nga.l2 <- spTransform(nga.l2, CRS("+init=epsg:4326"))

# LGA Centroids
nga.l2.pts <- data.table(coordinates(nga.l2))
setnames(nga.l2.pts, c("X", "Y"))
nga.l2.pts <- cbind(nga.l2.pts, nga.l2@data[, c(9,10,5,6,1,2)])

# Check names against micro data
setkey(nga.l2.pts, ADM2_NAME)
setkey(nga.hh, calc_lga)
nga.hh[!nga.l2.pts, unique(calc_lga), by=calc_state]
#    calc_state           V1
# 1:     Kaduna Birnin-Gwari -> Birnin Gwari
# 2:     Kaduna       Chukun -> Chikun
# 3:    Katsina        Kahur -> Kafur (Katsina), verified in QGIS
# 4:       Kano   Tudun Wada -> Tundun Wada

nga.hh[, .N, keyby=.(calc_state, calc_lga)]
tmp <- nga.l2.pts[, .N, keyby=.(ADM1_NAME, ADM2_NAME)]

# Recodes
nga.l2.pts[, svyL2Nm := factor(ADM2_NAME)]
levels(nga.l2.pts$svyL2Nm)[c(109,139,397,709)] <- c("Birnin-Gwari", "Chukun", "Kahur", "Tudun Wada")
setkey(nga.l2.pts, svyL2Nm)
setkey(nga.hh, calc_lga)
nga.hh[!nga.l2.pts, unique(calc_lga), by=calc_state]
# Empty data.table (0 rows) of 2 cols: calc_state,V1 => OK

# Impute NAs with centroids
nga.hh[nga.l2.pts, `:=`(calc_lga_X=i.X, calc_lga_Y=i.Y)]
nga.hh[is.na(calc_lga_X), .N]
nga.hh[, `:=`(X_imp=X, Y_imp=Y)]
nga.hh[is.na(X*Y), `:=`(X_imp=calc_lga_X, Y_imp=calc_lga_Y)]

# Also recode LGA map
nga.l2$svyL2Nm <- factor(nga.l2@data$ADM2_NAME)
levels(nga.l2$svyL2Nm)[c(109,139,397,709)] <- c("Birnin-Gwari", "Chukun", "Kahur", "Tudun Wada")

# Check to make sure existing coords fall in expected LGA
nga.pts <- SpatialPointsDataFrame(nga.hh[, .(X_imp,Y_imp)], data.frame(nga.hh),
  proj4string=CRS("+init=epsg:4326"))

nga.odd <- data.table(extract(nga.l2, nga.pts))
nga.odd <- cbind(nga.odd, nga.pts@data)
nga.odd <- nga.odd[calc_lga != svyL2Nm]
# => need to map these

# Export to STATA
nga.odd <- nga.odd[, .SD, .SDcols=c(1,3:4,7:8,11:12,20:25, 28:29)]
setcolorder(nga.odd, c(1,8:11,13,12,14,15,2:7))
setattr(nga.odd, "var.labels", 
  c("location id", "household id", "state", "LGA", "village", "longitude", "latitude",
    "longitude (imputed with centroid)", "latitude (imputed with centroid)",
    "GAUL LGA code", "GAUL LGA name", "GAUL state code", "GAUL state name",
    "GAUL country code", "GAUL country name"))
write.dta(nga.odd, "./out/2017-abt-nga_odd.dta", version=12L, convert.factors="string")

# Make and save map
tmp <- nga.pts[nga.odd$point.ID,]

m.nga <- tm_shape(nga.l2) +
  tm_polygons(fill="grey90", border.col="grey80", alpha=.2) + 
  tm_text("svyL2Nm", col="grey30", size="AREA", root=4) +
  tm_shape(tmp, is.master=T, projection="eck4") +
  tm_dots(col="calc_lga", shape=4, alpha=.5,
    legend.show=F, size=0.08, palette=viridis(22)) +
  tm_text("calc_lga", col="calc_lga", size=.4, legend.col.show=F, palette=viridis(22), auto.placement=1, remove.overlap=T) +
  tm_scale_bar(position=c("left", "bottom"), breaks=c(0,20,40,60)) +
  tm_layout(' "Problematic" Household Locations, Nigeria  ', 
    title.color="white", title.size=.8, title.bg.color="grey30",
    title.bg.alpha=.8, title.position=c("LEFT", "BOTTOM"))

save_tmap(m.nga, "./out/2017-abt-nga_odd.pdf", width=5, units="in")

```

```{r ken, eval=FALSE}

#####################################################################################
# Kenya Locations
#####################################################################################
# Load KEN coords
ken.hh <- fread("./data/gis_kenya_for consultant.csv")
setnames(ken.hh, tolower(names(ken.hh)))

# Use coords from round #2 if available, else round #1
ken.hh[, X := ifelse(is.na(bl2_gps_lo), gps_lo, bl2_gps_lo)]
ken.hh[, Y := ifelse(is.na(bl2_gps_la), gps_la, bl2_gps_la)]

# Missing?
ken.hh[is.na(X), .N]
# [1] 30

# Use the latest county map from CELL5M
load("~/Projects/hc-cell5m/rdb/g2.rda")
ken.l2 <- g2[g2$ADM0_NAME=="Kenya",]
# Has 47 counties from the new constitution
rm(g2)

# Reproject
ken.l2 <- spTransform(ken.l2, CRS("+init=epsg:4326"))

# Verify the status/version of this map
ken.l2.pts <- data.table(ken.l2@data)
setnames(ken.l2.pts, tolower(names(ken.l2.pts)))
ken.l2.pts[, rn := row.names(ken.l2)]

# County centroids
tmp <- data.table(coordinates(ken.l2))
setnames(tmp, c("X", "Y"))
ken.l2.pts <- cbind(tmp, ken.l2.pts)

# Check to make sure existing coords fall in expected LGA
ken.pts <- SpatialPointsDataFrame(ken.hh[!is.na(X), .(X,Y)], data.frame(ken.hh[!is.na(X)]),
  proj4string=CRS("+init=epsg:4326"))

tmp <- data.table(extract(ken.l2, ken.pts))
tmp <- cbind(tmp[, c(3:8)], ken.pts@data)

# Merge admin details back into `ken.hh`
setnames(tmp, tolower(names(tmp)))
setkey(tmp, hhid)
setkey(ken.hh, hhid)
ken.hh <- tmp[, .SD, .SDcols=1:7][ken.hh]
setcolorder(ken.hh, c(7:13, 6,3,5,2,4,1))

# Export to STATA
setattr(ken.hh, "var.labels", 
  c("household id",
    "latitude (round #1)", "longitude (round #1)",
    "latitude (round #2)", "longitude (round #2)",
    "longitude (for mapping)", "latitude (for mapping)",
    "GAUL county code", "GAUL county name", "GAUL province code", "GAUL province name",
    "GAUL country code", "GAUL country name"))
write.dta(ken.hh, "./out/2017-abt-ken_hh.dta", version=12L, convert.factors="string")

# Make and save map
ken.pts <- SpatialPointsDataFrame(ken.hh[!is.na(X), .(X,Y)], data.frame(ken.hh[!is.na(X)]),
  proj4string=CRS("+init=epsg:4326"))

m.ken <- tm_shape(ken.l2) +
  tm_polygons(fill="grey90", border.col="grey80", alpha=.2) + 
  tm_shape(ken.pts, is.master=T, projection="eck4") +
  tm_dots(col="adm2_name", shape=4, alpha=.3,
    legend.show=F, size=0.06, palette=viridis(47)) +
  tm_shape(ken.l2) +
  tm_text("ADM2_NAME", col="grey30", size="AREA", root=4) +
  tm_scale_bar(position=c("left", "bottom"), breaks=c(0,40,80)) +
  tm_layout(" Household Locations, Kenya  ",
    title.color="white", title.size=.8, title.bg.color="grey30", 
    title.bg.alpha=.8, title.position=c("LEFT", "BOTTOM"))

save_tmap(m.ken, "./out/2017-abt-ken_hh.pdf", width=5, units="in")

# Also save county and coords for QGIS
shapefile(ken.l2, "./maps/ken-abt-17_L2.shp")
shapefile(ken.pts, "./maps/ken-abt-17_hh.shp")

# TODO Impute missing with County centroid


```


```{r uga, eval=FALSE}

#####################################################################################
# Uganda Locations
#####################################################################################


```

```{r save, eval=FALSE}

rm(tmp, x, i)
save.image("./tmp/2017-abt.RData")

```

```{abstract}

Biophysical, socio-economic, and market information derived from high-resolution remote sensing and modeled time series.

```

# Data Sources

## Biophysical Conditions

### Long-term Time Series

Need to generate seasonal (maize, March-April-May-June) biophysical indices over the study years (2015-2017).

CRU TS 4.00
http://browse.ceda.ac.uk/browse/badc/cru/data/cru_ts/cru_ts_4.00/

### Current Conditions

#### IrriSAT

[IrriSAT](https://irrisat-cloud.appspot.com/) is a weather based irrigation scheduling service which is used to inform farmers how much water their crop has used and how much how much irrigation they need to apply. Information is produced daily, and can work across large spatial scales. The IrriSAT methodology uses satellite images to determine a Normalized Difference Vegetation Index (NDVI) for each field, from which the plant canopy size can be determined and a specific crop coefficient (Kc) can be estimated.

IrriSAT provides a [web API](https://irrisat-cloud.appspot.com/api) to batch retrieve daily NDVI and Kc at specified locations.

```
irrisat.services.data.cropgrowth()
```

#### CHIRPS



#### ERA-Interim (Jan 1979 - present)

ERA-Interim is a global atmospheric reanalysis from 1979, continuously updated in real time. The operational analysis is produced four times a day at 00:00, 06:00, 12:00 and 18:00 UTC. It has spatial resolution of about 16 km. The first layer of soil is 0-7cm. Normally we should correct for altitude.

```{r}

tmp <- fread("
Key:Value
Stream:Atmospheric model
Area:15.0°N 2.0°E 6.0°S 43.0°E
Type:Analysis
Dataset:interim_daily
Step:0
Version:1
Type of level:Surface
Time:06
Date:20150101 to 20170331
Grid:0.125° x 0.125°
Parameter:Soil temperature level 1
Class:ERA Interim", sep=":")

kable(tmp, caption="ERA Interim Soil Temperature at 0-7cm (request details)")

```

#### FEWSNET

Also look at USGS FEWSNET data products at:

- http://ewx.chg.ucsb.edu:8080/EWX/index.html
- https://earlywarning.usgs.gov/fews/mapviewer/index.php?region=af

### Drought

Aside from SPEIBase, drought events are also tracked by NASA EONET. There's an R package for this at http://enelmargen.org/nasadata/vignette_v0/.

```

{
"title": "EONET Event Categories",
	"description": "List of all the available event categories in the EONET system",
	"link": "http://eonet.sci.gsfc.nasa.gov/api/v2.1/categories",
	"categories": [
		{
			"id": 6,
			"title": "Drought",
			"link": "http://eonet.sci.gsfc.nasa.gov/api/v2.1/categories/6",
			"description": "Long lasting absence of precipitation affecting agriculture and livestock, and the overall availability of food and water.",
			"layers": "http://eonet.sci.gsfc.nasa.gov/api/v2.1/layers/6"
		}
}
		
```

## Soil Characteristics



## Market Access


# Survey Sampling

The tables and maps below provide details of household locations across the 3 survey samples.

In particular we highlight households with missing and problematic GPS coordinates. In the case of missing coordinates a location is imputed using the centroid of that household's administrative unit (LGA for Nigeria, county for Kenya, and district for Uganda). Note that another approach would be to derive average statistics over that entire administrative unit and use these values to impute household characteristics. However this approach requires substantial processing.

In the case of erroneous coordinates (locations falling largely outside of a household's administrative unit).

## Nigeria

**`r format(nrow(nga.hh), big.mark=",")`** households are sampled in Nigeria. There are **`r nga.hh[is.na(X), .N]`** households missing coordinates and **`r nrow(nga.odd)` erroneous** locations.

```{r nga-na, results="asis"}

# How many NAs?
tmp <- nga.hh[, .(N=.N, miss=sum(is.na(X))), keyby=.(calc_state, calc_lga)]

table_options(HTMLcaption="(#tab:nga-na) Survey Sampling across LGAs and missing Household Locations")
html(tabular((`State`=Factor(calc_state))*((`LGA`=Factor(calc_lga))*DropEmpty()+1)+1~Heading("Nigeria Household GPS Locations")*(Heading("Obs.")*N+Heading("Missing")*miss)*Format(big.mark=",")*Heading()*sum, data=tmp), rmarkdown=T)

```

Over 400 households have GPS coordinates that do not fall within their recorded LGA. In the majority of instances the distance is negligeable (under 10km) and this might not affect any of the spatial estimates. In a few instances the errors are more troublesome (over 40km). Households with problematic locations are highlighted on the map and in the table below.


```{r nga-odd, fig.cap="Households Located outside of their Recorded LGA, Nigeria", fig.height=8}

# Are all locations in the correct LGA
tmap_mode("plot")
m.nga

# kable(nga.odd[, .(hhid, calc_lga, ADM2_NAME), keyby=calc_state], padding=0,
#   caption="Households with Problematic GPS Coordinates, Nigeria")


```

## Kenya

**`r prettyNum(nrow(ken.hh))` households** are sampled in Kenya. There are **`r ken.hh[is.na(X), .N]`** households missing coordinates and **` nrow(ken.odd)` erroneous** locations.


```{r ken-na, results="asis"}

# How many NAs?
tmp <- ken.hh[, .(N=.N, miss=sum(is.na(X))), 
  keyby=.(adm1_name=as.character(adm1_name), adm2_name=as.character(adm2_name))]
tmp[is.na(adm1_name), `:=`(adm1_name=" N/A", adm2_name=" N/A")]

table_options(HTMLcaption="(#tab:ken-na) Survey Sampling across Counties and missing Household Locations")
html(tabular((`Province`=Factor(adm1_name))*((`County`=Factor(adm2_name))*DropEmpty()+1)+1~Heading("Kenya Household GPS Locations")*(Heading("Obs.")*N+Heading("Missing")*miss)*Format(big.mark=",")*Heading()*sum, data=tmp), rmarkdown=T)

```


```{r ken-hh, fig.cap="Households Locations across Counties, Kenya", fig.height=6}

# Are all locations in the correct LGA
tmap_mode("plot")
m.ken

```

## Uganda

**` prettyNum(nrow(uga.hh))` households** are sampled in Kenya. There are **` uga.hh[is.na(X), .N]`** households missing coordinates and **` nrow(uga.odd)` erroneous** locations.

